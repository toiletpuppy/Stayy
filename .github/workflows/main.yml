name: Build Unsigned IPA and Upload

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-and-upload:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install CocoaPods Dependencies
        run: |
          # Install CocoaPods if not already available and run pod install.
          gem install cocoapods
          pod install

      - name: Archive the Xcode Project (Disable Code Signing)
        run: |
          # Clean and archive the project with signing disabled.
          xcodebuild clean archive \
            -project Stay.xcodeproj \
            -scheme "Stay" \
            -configuration Release \
            -archivePath build/Stay.xcarchive \
            CODE_SIGNING_ALLOWED=NO

      - name: Create Unsigned IPA from Archive
        run: |
          # The archive (.xcarchive) contains the built app at:
          #   build/Stay.xcarchive/Products/Applications/Stay.app
          #
          # Create a Payload folder, copy the .app, then zip and rename to .ipa.
          mkdir -p build/Payload
          cp -R build/Stay.xcarchive/Products/Applications/Stay.app build/Payload/
          cd build
          zip -r Stay.zip Payload
          mv Stay.zip Stay.ipa
          ls -l Stay.ipa

      - name: Upload IPA to GoFile
        uses: toiletpuppy/gofile@New
        with:
          files: "build/Stay.ipa"
